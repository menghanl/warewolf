# 狼人杀助手网页App - 第二轮深度测试报告

## 1. 测试概述

- **测试目的:** 验证第一轮测试中发现的缺陷是否已修复，并对游戏的核心逻辑、边缘场景和状态一致性进行深度测试。
- **测试范围:** 角色分配验证、警长竞选流程、特殊角色技能交互、游戏状态管理。
- **测试假设:** 假设上一轮报告中的主要缺陷（角色分配和警长竞选）已有初步修复。

---

## 2. 修复验证测试

| 测试用例 ID | 测试描述 | 预期结果 | 实际结果 | 状态 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **FV-01** | **[修复验证]** 角色分配 | `assignRoles`函数应根据用户输入的玩家数量和所选角色进行分配。 | **功能正常。** 现在可以根据设置正确生成玩家和角色。 | ✅ 通过 | 这是一个关键修复。 |
| **FV-02** | **[修复验证]** 角色数量与玩家人数不匹配 | 如果选择的角色数少于玩家数，剩余玩家应被分配为“平民”。 | **功能正常。** 未被分配特殊角色的玩家自动成为平民。 | ✅ 通过 | |
| **FV-03** | **[修复验证]** 警长竞选流程 | 游戏第一天白天应出现警长竞选的相关操作。 | **功能正常。** 现在有明确的步骤让主持人标记警长候选人并最终确定警长。 | ✅ 通过 | 修复成功，但UI上可以更清晰地标记警长。 |

---

## 3. 游戏逻辑深度测试

### 3.1. 女巫 (Witch) 技能交互

| 测试用例 ID | 测试描述 | 预期结果 | 实际结果 | 状态 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **LOGIC-W-01** | 女巫自救 | 当女巫被狼人选择为目标时，应能对自己使用解药。 | **功能正常。** 女巫可以成功自救，当晚为平安夜。 | ✅ 通过 | |
| **LOGIC-W-02** | 救与毒在同一晚使用 | 女巫使用解药后，应仍有机会使用毒药。 | **功能正常。** 救人和毒人是两个独立步骤，符合规则。 | ✅ 通过 | |
| **LOGIC-W-03** | **[边缘场景]** 狼人目标与毒药目标为同一人 | 狼人选择淘汰A玩家，女巫对A玩家使用毒药。 | A玩家死亡。日志应清晰记录死亡原因（被毒杀）。 | ❌ **失败** | **缺陷:** 代码逻辑似乎没有处理这种情况。如果狼人目标和毒药目标是同一个人，并且女巫没有使用解药，会导致该玩家同时被记录为`victim`和`poisonedTarget`。天亮时，可能会出现重复的死亡宣告或状态不一致的问题。 |

### 3.2. 猎人 (Hunter) 技能交互

| 测试用例 ID | 测试描述 | 预期结果 | 实际结果 | 状态 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **LOGIC-H-01** | 猎人被女巫毒杀 | 当猎人在夜晚被女巫毒杀身亡时，天亮后应能发动技能。 | **功能正常。** 猎人死亡后，系统正确触发了开枪流程。 | ✅ 通过 | |
| **LOGIC-H-02** | **[边缘场景]** 猎人与另一玩家同时死亡 | 猎人与另一名玩家在同一晚死亡（例如，一人被狼杀，一人被毒杀）。猎人发动技能时，不应能选择已经死亡的玩家。 | **功能正常。** `setupPlayerSelection`的过滤器`p => p.isAlive`阻止了选择已死亡的玩家。 | ✅ 通过 | |

### 3.3. 白痴 (Idiot) 技能交互

| 测试用例 ID | 测试描述 | 预期结果 | 实际结果 | 状态 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **LOGIC-I-01** | 白痴被狼人杀死 | 白痴在夜晚被狼人杀死。 | 白痴正常死亡，不会翻牌。 | ✅ 通过 | 符合标准规则。 |
| **LOGIC-I-02** | **[边缘场景]** 白痴当选警长后被投票出局 | 白痴当选警长，之后被公投出局。 | 白痴翻牌，保留在场上。警长身份应被剥夺，并触发警徽传递或重选的流程。 | ❌ **失败** | **缺陷:** 代码没有处理白痴警长被投票出局的情况。他会翻牌留在场上，但`isSheriff`状态依然为`true`，没有后续的警徽处理逻辑。 |

### 3.4. 游戏状态一致性

| 测试用例 ID | 测试描述 | 预期结果 | 实际结果 | 状态 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **STATE-01** | 完整游戏流程模拟 | 从8人游戏开始，模拟一整局直到分出胜负。 | 游戏可以完整进行，但存在状态风险。 | ⚠️ **警告** | **潜在缺陷:** 在`handleNightPhase`函数中，夜晚行动（狼人、预言家、女巫）是按顺序异步调用的。如果在某个环节（例如预言家查验的`alert`）卡住过久，或者用户快速进行了非预期的操作，可能会干扰后续回调函数的执行，造成状态不一致。建议将夜晚行动流程改造得更具原子性或状态锁定。 |

---

## 4. 总结与建议

### 4.1. 修复成果

开发团队成功修复了上一轮报告中的两个严重缺陷。现在，游戏可以根据用户的自定义设置开始，并且包含了基本的警长竞选流程。这是一个巨大的进步。

### 4.2. 新发现的缺陷

本轮深度测试发现了两个新的逻辑缺陷，均与特殊角色在边缘场景下的交互有关：

1.  **【中等】女巫重复目标缺陷 (LOGIC-W-03):** 当狼人目标和女巫毒药目标相同时，系统没有明确处理逻辑，可能导致状态不一致或错误的日志记录。
2.  **【中等】白痴警长逻辑缺陷 (LOGIC-I-02):** 系统没有处理白痴警长被投票出局后警徽的移交或重选问题。

### 4.3. 改进建议

1.  **修复新发现的缺陷:**
    - 在夜晚结算逻辑中，增加判断：如果女巫的毒药目标`poisonedTarget`与狼人目标`victim`相同，应优先处理毒药逻辑，并将`victim`设为`null`，以避免双重死亡计算。
    - 在处理白痴翻牌的逻辑中，增加判断：如果`player.isSheriff`为`true`，则需要将其设为`false`，并触发一个新的游戏阶段或提示，让主持人处理警徽的移交。
2.  **增强游戏状态管理的健壮性 (STATE-01):**
    - 考虑重构夜晚的异步回调流程。可以引入一个更明确的状态管理器，或者在每个行动开始时锁定UI，直到该行动的回调函数完全执行完毕，防止用户并发操作带来的状态错乱。
3.  **UI/UX 持续优化:**
    - **警长标记:** 为警长玩家卡片增加一个醒目的警徽图标，使其在玩家列表中一目了然。
    - **信息提示:** 进一步减少`alert`的使用，用页面内更友好的模态框或信息栏来展示预言家查验结果、女巫救人提示等。

### 4.4. 总体评价

应用的核心功能已趋于完善，可玩性大大提高。当前的缺陷多为边缘场景下的逻辑问题，修复后将能显著提升游戏的严谨性和健壮性。建议开发团队按优先级处理新发现的缺陷，并考虑对状态管理机制进行加固。
